# 新项目避免二次烧录问题指南

> **适用场景**：创建STM32新项目时使用此指南，避免出现"第一次烧录成功，第二次失败"的问题  
> **目标读者**：使用STM32CubeMX + Keil/IAR进行开发的工程师  
> **重要程度**：⭐⭐⭐⭐⭐ 必读！

---

## 🎯 问题简述

**问题表现**：
- 第一次烧录程序成功
- 第二次烧录失败，调试器无法连接芯片
- 错误信息："No Cortex-M Device found"

**根本原因**：
- STM32CubeMX生成的代码中，`__HAL_AFIO_REMAP_SWJ_DISABLE()` 禁用了SWD调试接口
- 程序运行后将PA13/PA14变成普通GPIO
- 导致调试器无法连接

---

## ✅ 预防清单（新项目必做）

### 1. STM32CubeMX配置阶段 ⭐⭐⭐⭐⭐

#### 步骤1：打开SYS配置

```
1. 在CubeMX中打开项目
2. 左侧导航：System Core → SYS
3. 找到 Debug 选项
```

#### 步骤2：正确配置Debug

**关键设置**：
```
Debug: Serial Wire  ✅ 正确选择

不要选择：
Debug: Disable     ❌ 错误！会导致二次烧录失败
```

**效果**：
- ✅ 选择 "Serial Wire" 会生成：`__HAL_AFIO_REMAP_SWJ_NOJTAG()`
- ❌ 选择 "Disable" 会生成：`__HAL_AFIO_REMAP_SWJ_DISABLE()`

#### 配置截图参考

```
┌────────────────────────────────────┐
│ System Core → SYS                  │
├────────────────────────────────────┤
│                                    │
│ Timebase Source: SysTick           │
│                                    │
│ Debug:  [Serial Wire ▼]           │  ← 选择这个！
│                                    │
│ 可选项：                           │
│   - No Debug                       │
│   - Serial Wire      ← ✅ 选这个  │
│   - JTAG (4 pins)                  │
│   - JTAG (5 pins)                  │
│   - Trace Asynchronous             │
│                                    │
└────────────────────────────────────┘
```

---

### 2. 代码生成后检查 ⭐⭐⭐⭐

#### 检查文件：`stm32xxx_hal_msp.c`

**位置**：`Core/Src/stm32f1xx_hal_msp.c`（或对应型号）

**查找函数**：`HAL_MspInit()`

**期望代码**：
```c
void HAL_MspInit(void)
{
  __HAL_RCC_AFIO_CLK_ENABLE();
  __HAL_RCC_PWR_CLK_ENABLE();

  /** NOJTAG: JTAG-DP Disabled and SW-DP Enabled */
  __HAL_AFIO_REMAP_SWJ_NOJTAG();  // ✅ 正确
}
```

**错误代码**：
```c
void HAL_MspInit(void)
{
  __HAL_RCC_AFIO_CLK_ENABLE();
  __HAL_RCC_PWR_CLK_ENABLE();

  /** DISABLE: JTAG-DP Disabled and SW-DP Disabled */
  __HAL_AFIO_REMAP_SWJ_DISABLE();  // ❌ 错误！必须修改
}
```

**如果发现错误代码，立即修改为**：
```c
__HAL_AFIO_REMAP_SWJ_NOJTAG();
```

---

### 3. Keil/IAR调试器配置 ⭐⭐⭐⭐

#### 在Keil中配置

**步骤**：
```
1. Project → Options for Target (Alt + F7)
2. Debug 选项卡
3. Use: 选择调试器
   - CMSIS-DAP Debugger (推荐)
   - ST-Link Debugger
   - J-Link / J-Trace Cortex
4. 点击 Settings 按钮
5. 配置：
   Port: SW (选择SWD模式)
   ☑ Connect Under Reset (必须勾选)
   Max Clock: 1000 kHz (或更高)
```

**Connect Under Reset的重要性**：
- ✅ 即使程序有问题也能连接
- ✅ 作为额外保险措施
- ✅ 开发阶段建议始终启用

---

### 4. 首次烧录验证 ⭐⭐⭐

#### 验证步骤

**第一次烧录**：
```
1. 编译项目 (F7)
2. 下载程序 (F8)
3. 应该成功 ✅
```

**立即第二次烧录**（关键！）：
```
1. 不要断电
2. 不要手动复位
3. 立即按 F8 再次下载
4. 必须成功 ✅
```

**如果第二次失败**：
- ❌ 说明SWD被禁用，回到步骤2检查代码
- ❌ 需要使用恢复方法（见下文）

---

## 🔧 Cursor AI 集成

### 创建项目规则文件

在项目根目录创建或更新 `.cursorrules` 文件：

```markdown
# STM32项目开发规则

## 调试接口配置

**严格要求**：
- 开发阶段不允许禁用SWD调试接口
- CubeMX配置时必须选择 "Serial Wire"
- 代码中不允许使用 `__HAL_AFIO_REMAP_SWJ_DISABLE()`

**允许的配置**：
```c
// ✅ 允许（推荐）
__HAL_AFIO_REMAP_SWJ_NOJTAG();

// ✅ 允许（如果需要JTAG）
__HAL_AFIO_REMAP_SWJ_ENABLE();

// ❌ 禁止（开发阶段）
__HAL_AFIO_REMAP_SWJ_DISABLE();
```

**代码审查重点**：
每次代码生成后，必须检查 `stm32xxx_hal_msp.c` 文件中的 `HAL_MspInit()` 函数。

**引脚使用规划**：
- PA13 (SWDIO) - 保留用于调试，不可用作其他功能
- PA14 (SWCLK) - 保留用于调试，不可用作其他功能
- PA15, PB3, PB4 - 可以自由使用（如使用SWJ_NOJTAG配置）

## 外设初始化注意事项

**I2C外设**：
- 如果硬件上没有I2C设备，考虑禁用I2C初始化
- 避免I2C超时导致程序卡死

**EEPROM功能**：
- 使用前先检测EEPROM是否存在
- 使用 `HAL_I2C_IsDeviceReady()` 进行检测
```

---

## 📋 快速检查表

### 新项目创建后立即检查

```
项目配置检查：
□ CubeMX中Debug设置为 "Serial Wire"
□ 生成代码后检查HAL_MspInit()函数
□ 确认使用SWJ_NOJTAG而不是SWJ_DISABLE
□ Keil/IAR中配置Connect Under Reset
□ 首次烧录后立即测试第二次烧录

引脚使用检查：
□ PA13未被其他功能占用
□ PA14未被其他功能占用
□ 如需使用PA13/PA14，有特殊处理方案

调试器配置检查：
□ 调试器类型正确选择
□ Port设置为SW
□ Connect Under Reset已勾选
□ 通信速度合适（1-5MHz）
```

---

## 🚨 常见错误配置

### 错误1：CubeMX选择Disable

**错误配置**：
```
System Core → SYS → Debug: Disable
```

**后果**：
- 生成 `__HAL_AFIO_REMAP_SWJ_DISABLE()`
- 第二次烧录失败

**正确配置**：
```
System Core → SYS → Debug: Serial Wire
```

---

### 错误2：手动禁用SWD

**错误代码**：
```c
// 某些开发者为了释放引脚手动添加
__HAL_AFIO_REMAP_SWJ_DISABLE();
```

**后果**：
- PA13/PA14变成普通GPIO
- 无法调试和烧录

**正确做法**：
- 开发阶段不要禁用
- 如需引脚，使用SWJ_NOJTAG释放PA15/PB3/PB4

---

### 错误3：未启用Connect Under Reset

**后果**：
- 如果程序有问题，调试器可能无法连接
- 降低了容错能力

**正确做法**：
- 始终勾选Connect Under Reset
- 作为额外保险措施

---

## 🔄 不同STM32系列适用性

### STM32F1系列

**适用型号**：
- STM32F103
- STM32F105
- STM32F107

**配置宏**：
```c
__HAL_AFIO_REMAP_SWJ_NOJTAG();  // 推荐
__HAL_AFIO_REMAP_SWJ_DISABLE(); // 避免使用
```

---

### STM32F4系列

**配置位置**：
- 也在 `stm32f4xx_hal_msp.c` 中
- 函数名相同：`HAL_MspInit()`

**注意事项**：
- STM32F4的引脚可能不同
- 但原理相同，不要禁用SWD

---

### STM32L系列、STM32G系列等

**通用原则**：
- 所有STM32系列都有类似的调试接口配置
- 都要避免完全禁用SWD
- 开发阶段保留调试功能

---

## 💡 最佳实践

### 开发阶段

1. **始终保留SWD**
   - 使用 `SWJ_NOJTAG` 而不是 `SWJ_DISABLE`
   - PA13/PA14保留用于调试

2. **启用保护措施**
   - Connect Under Reset
   - 合适的通信速度

3. **首次验证**
   - 每个新项目都测试第二次烧录
   - 确保问题早发现

---

### 生产阶段

1. **评估是否禁用**
   - 是否真的需要PA13/PA14？
   - 是否还需要调试和更新？

2. **保留后门**
   - 即使禁用SWD，也保留串口烧录
   - 或保留BOOT0引脚访问

3. **充分测试**
   - 禁用SWD前充分测试
   - 确保程序稳定

---

## 🆘 问题已发生时的恢复方法

### 快速恢复流程

如果已经烧录了禁用SWD的程序：

**方法1：BOOT0引脚**
```
1. BOOT0接高电平（3.3V）
2. 复位芯片
3. 进入系统Bootloader
4. 通过串口或J-Link烧录修复后的程序
5. BOOT0接地，重新上电
```

**方法2：Connect Under Reset + 手动复位**
```
1. Keil中启用Connect Under Reset
2. 连接NRST引脚
3. 按住RESET按钮
4. 在Keil中下载
5. 看到连接时松开RESET
```

**方法3：J-Link Commander擦除**
```
1. 使用BOOT0=1进入Bootloader
2. 运行J-Link Commander
3. connect → erase
4. 烧录修复后的程序
```

详细步骤见：`EEPROM设置不当导致无法二次烧录.md`

---

## 📝 项目模板建议

### 创建标准项目模板

建议创建一个标准的STM32项目模板，包含：

1. **正确的CubeMX配置**
   - Debug: Serial Wire
   - 其他常用外设配置

2. **代码检查脚本**
   ```bash
   # check_swd.sh
   grep -n "SWJ_DISABLE" Core/Src/*.c
   if [ $? -eq 0 ]; then
       echo "错误：发现SWJ_DISABLE，请修改为SWJ_NOJTAG"
       exit 1
   fi
   ```

3. **文档说明**
   - README中说明调试接口配置
   - 提醒不要禁用SWD

---

## 🎓 培训要点

### 团队培训内容

1. **问题认知**
   - 了解二次烧录失败的原因
   - 理解SWD调试接口的重要性

2. **正确配置**
   - CubeMX正确配置方法
   - 代码检查要点

3. **验证方法**
   - 首次烧录后立即测试
   - 使用检查清单

4. **恢复方法**
   - BOOT0引脚使用
   - J-Link Commander操作

---

## 📊 对比总结

### 三种配置对比

| 配置 | 宏定义 | JTAG | SWD | 开发可用 | 释放引脚 | 推荐度 |
|------|--------|------|-----|---------|----------|--------|
| 全启用 | SWJ_ENABLE | ✅ | ✅ | ✅ | 0 | ⭐⭐⭐ |
| 仅SWD | SWJ_NOJTAG | ❌ | ✅ | ✅ | 3 | ⭐⭐⭐⭐⭐ |
| 全禁用 | SWJ_DISABLE | ❌ | ❌ | ❌ | 5 | ❌ |

**推荐**：开发阶段使用 `SWJ_NOJTAG`

---

## ✅ 验收标准

### 新项目验收

在项目交付或代码审查时，确认：

```
□ CubeMX配置正确（Serial Wire）
□ HAL_MspInit()使用正确的宏
□ Keil/IAR配置正确
□ 首次烧录成功
□ 第二次烧录成功
□ 连续多次烧录都成功
□ 文档中说明了调试接口配置
```

全部通过 = 项目配置正确 ✅

---

## 🔗 相关资源

### 参考文档

1. **本地文档**
   - `EEPROM设置不当导致无法二次烧录.md` - 问题详解
   - `SWD_DISABLE_FIX.md` - 技术原理

2. **官方文档**
   - STM32F1 Reference Manual (RM0008)
   - STM32CubeMX User Manual

3. **在线资源**
   - ST官方社区
   - STM32开发论坛

---

## 🎯 记忆要点

### 三个"必须记住"

1. **CubeMX配置**
   ```
   Debug: Serial Wire  ← 必须选这个
   ```

2. **代码检查**
   ```c
   __HAL_AFIO_REMAP_SWJ_NOJTAG();  ← 必须是这个
   ```

3. **立即验证**
   ```
   第一次烧录后，立即测试第二次 ← 必须验证
   ```

---

<div align="center">

## ✅ 总结

**预防措施**：
1. CubeMX选择 "Serial Wire"
2. 检查代码使用 `SWJ_NOJTAG`
3. 启用 Connect Under Reset
4. 首次烧录后立即测试

**验证方法**：
- 连续多次烧录都成功

**问题处理**：
- 参考 `EEPROM设置不当导致无法二次烧录.md`

---

**遵循此指南 = 避免二次烧录问题** ✅

**文档版本**：v1.0  
**最后更新**：2025-10-22  
**适用范围**：所有STM32系列MCU

</div>


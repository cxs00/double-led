# 规则快速索引

## 🎯 如何使用本索引

- 按 `Ctrl+F` 搜索关键词快速定位规则
- 点击链接跳转到详细文档
- 每个规则都有快速参考和详细说明

---

## 📚 规则分类

### 1️⃣ 硬件约束规则
**位置：** `current/hardware_constraints.md`

| 规则ID | 关键词 | 简述 | 详情 |
|--------|--------|------|------|
| HW-001 | SWD, JTAG | **必须使用SWD，禁用JTAG** | 避免二次烧录失败 |
| HW-002 | 74HC595, U1, U2, U6 | **3个74HC595级联配置** | U2输出经PNP反相 |
| HW-003 | 74HC165, 按键 | **9位按键输入** | 与595共享SPI |
| HW-004 | SPI2, PB13, PB14, PB15, PB7 | **SPI2引脚固定分配** | 不可更改 |
| HW-005 | 共阳极, 段码 | **数码管共阳极** | 段码取反，位选高有效 |
| HW-006 | LED映射 | **6个LED固定映射** | ALM, V, F/R, Hz, RUN, A |
| HW-007 | 按键映射 | **9个按键固定映射** | RUN到UP，SER+D0-D7 |

**快速参考：**
```c
// SPI引脚（固定）
PB13: SCLK
PB14: MISO
PB15: MOSI
PB7:  LATCH

// LED映射
LED_ALM=0, LED_V=1, LED_FR=2, LED_Hz=3, LED_RUN=4, LED_A=5

// 按键映射（74HC165）
SER→RUN, D0→RESERVED, D1→ENTER, D2→FUNC, D3→STOP
D4→DOWN, D5→RPG, D6→SHIFT, D7→UP
```

---

### 2️⃣ 编码规范
**位置：** `current/coding_standards.md`

| 规则ID | 关键词 | 简述 | 详情 |
|--------|--------|------|------|
| CS-001 | 段码表 | **共阳极段码必须取反** | 0xC0, 0xF9, ... |
| CS-002 | U2输出 | **U2数据必须再次取反** | 补偿PNP三极管 |
| CS-003 | 频率显示 | **低频XXX.XX，高频XXXX.X** | 小数点位置固定 |
| CS-004 | 小数点 | **低频第2位后，高频第3位后** | 用 `& ~0x80` 添加 |
| CS-005 | 按键扫描 | **KEY_Scan()电平触发** | 支持长按 |
| CS-006 | 长按参数 | **阈值250ms，重复100ms** | 已优化，不建议改 |
| CS-007 | 智能步进 | **超时500ms重置为级别1** | 必须遵守 |
| CS-008 | 刷新周期 | **显示20ms，按键50ms** | 用HAL_GetTick() |
| CS-009 | SPI顺序 | **先读键，再显示** | 避免冲突 |

**快速参考：**
```c
// 共阳极段码（已取反）
const uint8_t seg_code[] = {
    0xC0, 0xF9, 0xA4, 0xB0, 0x99,  // 0-4
    0x92, 0x82, 0xF8, 0x80, 0x90   // 5-9
};

// U2输出取反
u2_data = ~digit_select_data;

// 小数点位置
d7_buffer[2] = seg_code[digit] & ~0x80;  // 低频
d7_buffer[3] = seg_code[digit] & ~0x80;  // 高频

// 电平触发按键扫描
uint8_t KEY_Scan(void) {
    // 消抖
    if (key_state != key_last_state) { /* 消抖 */ }
    // 始终检测当前状态（不仅在变化时）
    if (key_state & 0x001) return KEY_RUN;
    // ...
}
```

---

### 3️⃣ 已知错误及解决方案
**位置：** `current/error_solutions.md`

| 错误ID | 关键词 | 症状 | 快速解决 |
|--------|--------|------|----------|
| ERR-01 | 二次烧录失败 | Flash Download failed | 用SWD，64KB算法 |
| ERR-02 | 长按无效 | 长按不触发 | KEY_Scan()电平触发 |
| ERR-03 | 高频小数点 | 00.001显示错误 | 小数点在d7_buffer[3] |
| ERR-04 | D8小数点 | 2451.3显示错误 | SEG_SetDigit_D8(2,x,1) |
| ERR-05 | 按键混乱 | STOP执行DOWN | 检查74HC165映射 |
| ERR-06 | 步进升级 | 每按一次升级 | 超过阈值才升级 |
| ERR-07 | case重复 | case label重复 | 检查枚举值 |
| ERR-08 | 变量未定义 | key_long_press_count | 添加变量声明 |
| ERR-09 | SPI未定义 | SPI_HandleTypeDef | include "stm32f1xx_hal_spi.h" |
| ERR-10 | DOWN步进 | DOWN步进错误 | 移除AutoSetStepLevel |
| ERR-11 | 长按延迟 | 重复触发延迟 | 用(count-threshold)%rate |

**快速诊断流程：**
```
烧录失败？     → ERR-01
按键不工作？   → ERR-02, ERR-05
显示错误？     → ERR-03, ERR-04
步进异常？     → ERR-06, ERR-10, ERR-11
编译错误？     → ERR-07, ERR-08, ERR-09
```

---

### 4️⃣ 智能步进规则
**位置：** `current/smart_stepping_rules.md`

| 模式 | 范围 | 级别1 | 级别2 | 级别3 | 级别4 |
|------|------|-------|-------|-------|-------|
| **低频** | 0.00-400.00Hz | 0.01Hz<br>(0.00-0.09) | 0.1Hz<br>(0.10-0.90) | 1Hz<br>(1.00-9.90) | 10Hz<br>(10.00-400.00) |
| **高频** | 0.0-4000.0Hz | 0.1Hz<br>(0.0-0.9) | 1Hz<br>(1.0-9.9) | 10Hz<br>(10.0-99.9) | 100Hz<br>(100.0-4000.0) |

**升级规则：**
- **UP键：** 频率超过阈值后升级（如0.09→0.10时）
- **DOWN键：** 频率为步进倍数时升级（如0.10, 1.00等）
- **超时：** 500ms无操作重置为级别1

**快速参考：**
```c
// 低频阈值
STEP1_MAX = 9    // 0.09Hz
STEP2_MAX = 90   // 0.90Hz
STEP3_MAX = 990  // 9.90Hz

// 高频阈值
STEP1_MAX = 90    // 0.9Hz
STEP2_MAX = 990   // 9.9Hz
STEP3_MAX = 9990  // 99.9Hz

// 超时重置
if (current_time - last_freq_key_time > 500) {
    current_step_level = STEP_LEVEL_1;
}
```

---

## 🔍 按问题类型查找

### 烧录问题
- **二次烧录失败** → ERR-01, HW-001
- **Flash Download failed** → ERR-01
- **JTAG chain error** → ERR-01, HW-001

### 显示问题
- **数码管不亮/全亮** → CS-001, CS-002, HW-005
- **小数点位置错误** → ERR-03, ERR-04, CS-003, CS-004
- **显示内容错误** → CS-001, CS-002
- **RUN灯看不见** → HW-006（亮度不够）

### 按键问题
- **长按不工作** → ERR-02, CS-005
- **按键功能错乱** → ERR-05, HW-007
- **按键不响应** → CS-009（SPI冲突）
- **长按重复延迟** → ERR-11

### 频率调节问题
- **步进级别错误** → ERR-06, ERR-10
- **步进不升级** → 智能步进规则
- **DOWN键步进错** → ERR-10
- **超时不重置** → CS-007

### 编译问题
- **case label重复** → ERR-07
- **变量未定义** → ERR-08
- **SPI类型未定义** → ERR-09
- **链接错误** → 检查包含文件

---

## 📖 按文件查找

### `current/.cursorrules`
- **完整规则文件**
- Cursor AI配置
- 所有规则的源文件

### `current/error_solutions.md`
- **11个已知错误**
- 详细症状描述
- 完整解决方案
- 代码示例

### `current/coding_standards.md`
- **编码规范**
- 显示代码规范
- 按键处理规范
- 时序控制规范

### `current/hardware_constraints.md`
- **硬件约束**
- 引脚定义
- 芯片配置
- LED/按键映射

### `current/smart_stepping_rules.md`
- **智能步进算法**
- 低频/高频模式
- 升级/降级逻辑
- 测试用例

---

## 🚀 快速入门路径

### 新开发者（第一次接触项目）
1. 阅读 `README.md` - 了解系统
2. 查看本文件 - 熟悉规则索引
3. 阅读 `current/hardware_constraints.md` - 了解硬件
4. 查看 `current/error_solutions.md` - 了解常见错误
5. 开始编码

### 遇到错误时
1. 在本文件搜索错误关键词
2. 跳转到对应的错误解决方案
3. 按步骤执行修复
4. 验证问题解决

### 添加新功能时
1. 查看 `current/coding_standards.md`
2. 遵循编码规范
3. 检查硬件约束
4. 测试功能

### 修改频率控制时
1. 查看 `current/smart_stepping_rules.md`
2. 了解升级逻辑
3. 保持阈值一致
4. 测试所有级别

---

## 📊 规则统计

- **硬件约束规则：** 7条
- **编码规范：** 9条
- **已知错误：** 11个
- **智能步进级别：** 4级 × 2模式
- **总规则数：** 35+

**状态：** ✅ 已验证，生产可用  
**最后更新：** 2025-10-25  
**版本：** v1.0

---

## 💡 使用技巧

### 快速搜索
```
Ctrl+F → 搜索关键词 → 找到规则ID → 跳转详细文档
```

### 问题诊断
```
遇到问题 → 本文件搜索症状 → 找到错误ID → 查看解决方案
```

### 规则查找
```
需要参考 → 本文件找分类 → 跳转详细文档 → 复制代码示例
```

### 6️⃣ 文件整合规则
**位置：** `current/file_integration_guide.md`

| 规则ID | 关键词 | 简述 | 详情 |
|--------|--------|------|------|
| FI-001 | UTF-8编码 | **必须使用chcp 65001** | 避免中文乱码 |
| FI-002 | 文件整合 | **标准整合流程** | 复制→验证→删除乱码 |
| FI-003 | 乱码映射 | **常见乱码文件夹映射** | 澶囦唤鐗堟湰→备份版本 |
| FI-004 | 完整性验证 | **972个文件验证** | 确保项目完整性 |

**快速参考：**
```batch
# 文件整合标准流程
@echo off
chcp 65001
# 检查乱码文件夹 → 复制文件 → 删除乱码 → 验证完整性
```

---

**提示：** 本索引会随着规则更新自动同步，始终保持最新！


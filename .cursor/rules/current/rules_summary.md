# STM32 500双数码管变频器控制系统 - 规则总览

## 📋 项目基本信息

| 项目 | 信息 |
|------|------|
| **项目名称** | 500双数码管变频器控制系统 |
| **版本** | v1.0 |
| **芯片型号** | STM32F103C8T6 (64KB Flash, 20KB SRAM) |
| **开发工具** | Keil MDK-ARM v5.25 + STM32CubeMX |
| **HAL库版本** | STM32Cube_FW_F1_V1.8.x |
| **调试接口** | SWD (J-Link V9) |
| **编译器** | ARM Compiler v5.05 |
| **最后更新** | 2025-10-25 |
| **状态** | ✅ 已验证，生产可用 |

---

## 🎯 核心功能

### 显示系统
- **D7数码管（5位）**：频率显示
  - 低频模式：XXX.XX Hz（0.00-400.00Hz）
  - 高频模式：XXXX.X Hz（0.0-4000.0Hz）
  
- **D8数码管（5位）**：电流显示
  - 格式：XXX.XX A

- **6个LED指示灯**：
  - ALM：报警指示
  - V：电压指示
  - F/R：正反转/高频模式指示
  - Hz：频率单位
  - RUN：运行指示
  - A：电流单位

### 输入系统
- **9个按键**（通过74HC165读取）：
  - RUN：运行键
  - STOP：停止/复位键
  - UP/DOWN：频率递增/递减键
  - ENTER：确认键
  - RPG：编程键
  - SHIFT：位移键
  - FUNC：功能切换键（低频/高频模式）
  - RESERVED：保留键

### 智能步进
- **低频模式（0.00-400.00Hz）**：
  - 级别1：0.01Hz步进（0.00-0.09Hz）
  - 级别2：0.1Hz步进（0.10-0.90Hz）
  - 级别3：1Hz步进（1.00-9.90Hz）
  - 级别4：10Hz步进（10.00-400.00Hz）

- **高频模式（0.0-4000.0Hz）**：
  - 级别1：0.1Hz步进（0.0-0.9Hz）
  - 级别2：1Hz步进（1.0-9.9Hz）
  - 级别3：10Hz步进（10.0-99.9Hz）
  - 级别4：100Hz步进（100.0-4000.0Hz）

- **自动升级**：频率超过当前级别范围自动升级
- **超时重置**：500ms无操作重置为级别1

### 按键特性
- **短按**：单次操作
- **长按**：
  - 阈值：250ms（5个扫描周期）
  - 重复速率：100ms（2个扫描周期）
  - UP/DOWN支持连续触发

---

## 🔌 硬件架构

### SPI2总线配置
```
STM32F103C8T6
    ├─ PB13 (SCLK)  ──┬── 74HC595 SRCLK ×3
    │                  └── 74HC165 SH/CLK
    ├─ PB14 (MISO)  ───── 74HC165 QH
    ├─ PB15 (MOSI)  ───── 74HC595 SER (U1)
    └─ PB7  (LATCH) ──┬── 74HC595 RCLK ×3
                       └── 74HC165 SH/LD
```

### 74HC595级联配置（3个芯片）
```
MOSI → [U1] → [U2] → [U6]
        │      │      │
        ↓      ↓      ↓
      D7段  位选择  D8段
      +LED阴  +LED阳
```

**详细说明：**
- **U1 (第1个595)**：
  - QA-QH → D7数码管a-dp段 + LED阴极
  - 控制D7的显示内容和LED的阴极

- **U2 (第2个595)**：
  - QA-QB → D7数码管DIG1-DIG5位选择
  - QC-QH → 6个LED的阳极（DIG_6）
  - **注意**：输出经PNP三极管反相，代码需要取反补偿

- **U6 (第3个595)**：
  - QA-QH → D8数码管a1-dp1段
  - 控制D8的显示内容

### 74HC165按键输入（9位）
```
74HC165
├─ SER (串行输入)  → RUN键
├─ D0             → RESERVED键
├─ D1             → ENTER键
├─ D2             → FUNC键
├─ D3             → STOP键
├─ D4             → DOWN键
├─ D5             → RPG键
├─ D6             → SHIFT键
└─ D7             → UP键
```

---

## 📊 系统规则统计

### 硬件约束规则
- **调试接口**：只使用SWD，禁用JTAG（7条）
- **SPI配置**：引脚固定，不可更改
- **数码管类型**：共阳极，段码取反
- **LED/按键映射**：固定映射，不可更改

### 编码规范
- **显示代码**：段码取反、U2输出取反、小数点位置（9条）
- **按键处理**：电平触发、长按支持
- **时序控制**：非阻塞设计、定时刷新

### 已知错误
- **已记录**：11个
- **分类**：烧录3个、显示2个、按键3个、步进3个
- **影响级别**：严重2个、中等7个、轻微2个

### 智能步进
- **模式**：2个（低频/高频）
- **级别**：每模式4级
- **阈值**：8个（每模式4个）
- **升级逻辑**：2套（UP/DOWN不同）

---

## ⚡ 性能参数

| 参数 | 值 | 说明 |
|------|-----|------|
| **显示刷新周期** | 20ms | 50Hz刷新率 |
| **按键扫描周期** | 50ms | 20Hz扫描率 |
| **长按阈值** | 250ms | 5个扫描周期 |
| **长按重复速率** | 100ms | 2个扫描周期 |
| **步进超时** | 500ms | 无操作重置步进级别 |
| **SPI速度** | 9MHz | BaudRatePrescaler=8 |
| **CPU频率** | 72MHz | STM32F103C8T6默认 |

---

## 🚦 状态机

### 运行状态
```
[停止] ─RUN键─> [运行] ─STOP键─> [停止]
   │                          │
   └───────────────────────────┘
            故障复位
```

### 频率模式
```
[低频模式] ─FUNC键─> [高频模式] ─FUNC键─> [低频模式]
  0.00-400.00Hz        0.0-4000.0Hz
```

### 步进级别
```
[级别1] ─超阈值─> [级别2] ─超阈值─> [级别3] ─超阈值─> [级别4]
0.01/0.1Hz        0.1/1Hz          1/10Hz        10/100Hz
    │                  │                │              │
    └──────────────────┴────────────────┴──────────────┘
                    超时500ms重置
```

---

## 📁 代码结构

### 核心文件
```
Core/
├── Inc/
│   ├── main.h                  # 主程序头文件
│   ├── stm32f1xx_hal_conf.h    # HAL配置
│   ├── key.h                   # 按键定义
│   ├── segment_display.h       # 数码管显示
│   └── spi_display.h           # SPI显示驱动
│
└── Src/
    ├── main.c                  # 主程序（状态机、业务逻辑）
    ├── stm32f1xx_hal_msp.c     # HAL MSP初始化
    ├── stm32f1xx_it.c          # 中断处理
    ├── key.c                   # 按键扫描与处理
    ├── segment_display.c       # 数码管显示实现
    └── spi_display.c           # SPI通信实现
```

### 关键函数
```c
// main.c
main()                          // 主循环
UpdateDisplay()                 // 更新显示
GetFreqStepValue()              // 获取步进值
CheckStepLevelUpgrade()         // 检查UP键步进升级
CheckStepLevelUpgradeForDown()  // 检查DOWN键步进升级

// key.c
KEY_Init()                      // 按键初始化
KEY_Scan()                      // 按键扫描（电平触发）
KEY_Read()                      // 读取74HC165数据

// segment_display.c
SEG_Init()                      // 数码管初始化
SEG_DisplayFrequency()          // 显示频率
SEG_SetDigit_D7()               // 设置D7某位数字
SEG_SetDigit_D8()               // 设置D8某位数字

// spi_display.c
SPI_Display_Init()              // SPI显示初始化
SPI_Display_Refresh()           // 刷新显示
SPI_Display_SetLED()            // 设置LED状态
```

---

## 🔍 常见问题快速索引

| 问题类型 | 快速跳转 |
|---------|---------|
| 烧录失败 | [错误解决方案 - ERR-01](error_solutions.md#err-01) |
| 按键不响应 | [错误解决方案 - ERR-02, ERR-05](error_solutions.md) |
| 显示异常 | [错误解决方案 - ERR-03, ERR-04](error_solutions.md) |
| 步进错误 | [智能步进规则](smart_stepping_rules.md) |
| 硬件连接 | [硬件约束](hardware_constraints.md) |
| 编码规范 | [编码规范](coding_standards.md) |

---

## 📖 文档导航

- **[规则快速索引](../RULES_INDEX.md)** - 查找任何规则
- **[错误解决方案](error_solutions.md)** - 11个已知错误
- **[编码规范](coding_standards.md)** - 代码书写规范
- **[硬件约束](hardware_constraints.md)** - 硬件限制
- **[智能步进规则](smart_stepping_rules.md)** - 步进算法
- **[变更日志](../CHANGELOG.md)** - 规则变更历史

---

## ✅ 检查清单

### 开发前检查
- [ ] 已阅读规则总览（本文件）
- [ ] 已了解硬件约束
- [ ] 已了解编码规范
- [ ] 已熟悉已知错误

### 编码时检查
- [ ] 使用SWD接口，禁用JTAG
- [ ] 数码管段码已取反
- [ ] U2输出已再次取反
- [ ] 按键映射正确
- [ ] 无阻塞延迟

### 编译前检查
- [ ] 无重复case标签
- [ ] 所有变量已声明
- [ ] 头文件已包含
- [ ] Flash算法正确（64KB）

### 烧录前检查
- [ ] Debug接口选择SWD
- [ ] J-Link连接正常
- [ ] 芯片型号正确（STM32F103C8）

### 测试清单
- [ ] 显示功能正常
- [ ] LED指示正常
- [ ] 按键响应正常
- [ ] 智能步进正常
- [ ] 长按功能正常
- [ ] 模式切换正常

---

**状态：** ✅ 当前规则已验证，可用于生产  
**版本：** v1.0  
**最后更新：** 2025-10-25


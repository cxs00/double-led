# 🔧 故障排除指南

> **项目**: STM32双数码管显示系统  
> **版本**: v1.0  
> **更新时间**: 2025-10-25  

---

## 🚨 快速诊断

### 症状检查表
- [ ] 数码管不显示
- [ ] LED不亮
- [ ] 按键无响应
- [ ] 编译错误
- [ ] 烧录失败
- [ ] 程序不运行
- [ ] 显示异常
- [ ] 频率调节异常

---

## 🔍 常见问题及解决方案

### 1️⃣ 数码管不显示

#### 症状
- 数码管完全黑屏
- 部分段不亮
- 显示乱码

#### 可能原因
1. **电源问题**: 电源未连接或电压不足
2. **SPI连接错误**: SPI2引脚连接错误
3. **74HC595级联错误**: 级联顺序错误
4. **共阳极特性**: 段码控制错误

#### 解决方案

##### 检查电源
```bash
# 检查电源电压
- STM32: 3.3V
- 74HC595/165: 5V
- 数码管: 5V
```

##### 检查SPI连接
```
STM32F103C8T6 → 74HC595
├─ PB13 (SCK) → SRCLK
├─ PB15 (MOSI) → SER
└─ PB7 (LATCH) → RCLK
```

##### 检查74HC595级联
```
U1 (D7段+LED阴) → U2 (位+LED阳) → U6 (D8段)
```

##### 检查段码控制
```c
// 共阳极数码管：低电平(0)点亮，高电平(1)熄灭
// 段码已取反，直接使用
const uint8_t seg_code[] = {
    0xC0, // 0: 0b11000000
    0xF9, // 1: 0b11111001
    // ...
};
```

#### 调试步骤
1. 检查电源连接
2. 检查SPI2引脚连接
3. 检查74HC595级联顺序
4. 检查段码表
5. 使用示波器检查SPI信号

---

### 2️⃣ LED不亮

#### 症状
- 所有LED不亮
- 部分LED不亮
- LED闪烁异常

#### 可能原因
1. **LED连接错误**: LED硬件连接错误
2. **U2反相问题**: PNP三极管反相未补偿
3. **LED映射错误**: LED位映射错误
4. **电源问题**: LED电源供应问题

#### 解决方案

##### 检查LED连接
```
LED编号  LED名称  功能          阴极(U1)  阳极(U2)
LED_D1   ALM     报警指示       a段      DIG_6
LED_D2   V       电压指示       b段      DIG_6
LED_D3   F/R     正反转/高频     c段      DIG_6
LED_D4   Hz      频率单位       d段      DIG_6
LED_D5   RUN     运行指示       e段      DIG_6
LED_D6   A       电流单位       f段      DIG_6
```

##### 检查U2反相补偿
```c
// U2输出经过PNP三极管反相，必须取反补偿
u2_data = ~original_data;
```

##### 检查LED映射
```c
// LED索引（固定不可更改）
#define LED_ALM  0  // D1 报警指示
#define LED_V    1  // D2 电压指示
#define LED_FR   2  // D3 F/R指示（高频模式）
#define LED_Hz   3  // D4 频率单位
#define LED_RUN  4  // D5 运行指示
#define LED_A    5  // D6 电流单位
```

#### 调试步骤
1. 检查LED硬件连接
2. 检查U2反相补偿
3. 检查LED映射
4. 检查LED控制代码
5. 使用万用表检查LED电压

---

### 3️⃣ 按键无响应

#### 症状
- 所有按键无响应
- 部分按键无响应
- 按键响应异常

#### 可能原因
1. **74HC165连接错误**: 74HC165硬件连接错误
2. **SPI通信异常**: SPI2通信异常
3. **按键硬件故障**: 按键硬件故障
4. **扫描频率问题**: 按键扫描频率过低

#### 解决方案

##### 检查74HC165连接
```
STM32F103C8T6 → 74HC165
├─ PB13 (SCK) → CLK
├─ PB14 (MISO) → QH
└─ PB7 (LATCH) → SH/LD
```

##### 检查按键映射
```
74HC165位  bit  按键名称     功能
SER        0    RUN        运行键
D0         1    RESERVED   保留键
D1         2    ENTER      确认键
D2         3    FUNC       功能键（模式切换）
D3         4    STOP       停止/复位键
D4         5    DOWN       递减键
D5         6    RPG        编程键
D6         7    SHIFT      位移键
D7         8    UP         递增键
```

##### 检查按键扫描
```c
// 按键扫描频率
#define KEY_SCAN_RATE         50      // 按键扫描频率 (Hz)
```

#### 调试步骤
1. 检查74HC165连接
2. 检查SPI2通信
3. 检查按键硬件
4. 检查按键扫描代码
5. 使用示波器检查按键信号

---

### 4️⃣ 编译错误

#### 症状
- 编译失败
- 链接错误
- 库文件缺失

#### 可能原因
1. **Keil版本不兼容**: Keil版本过低
2. **项目路径错误**: 项目路径包含中文或特殊字符
3. **库文件缺失**: HAL库文件缺失
4. **配置错误**: 项目配置错误

#### 解决方案

##### 检查Keil版本
```
要求: Keil MDK-ARM 5.x
推荐: Keil MDK-ARM 5.30+
```

##### 检查项目路径
```
要求: 路径不包含中文和特殊字符
推荐: 使用英文路径
例如: D:\stm32\BilibiliProject\500 double led\
```

##### 检查库文件
```
必需文件:
├── Core/
│   ├── Inc/
│   └── Src/
├── Drivers/
│   ├── CMSIS/
│   └── STM32F1xx_HAL_Driver/
└── MDK-ARM/
```

##### 检查项目配置
```
必需配置:
├── Target: STM32F103C8T6
├── Debug: J-Link / J-Trace Cortex
├── Port: SW (不选JTAG)
└── Flash Algorithm: STM32F10x 64K
```

#### 调试步骤
1. 检查Keil版本
2. 检查项目路径
3. 检查库文件
4. 检查项目配置
5. 重新创建项目

---

### 5️⃣ 烧录失败

#### 症状
- 烧录失败
- 调试器无法连接
- 芯片无法识别

#### 可能原因
1. **调试器连接错误**: J-Link连接错误
2. **SWD接口问题**: SWD接口连接错误
3. **芯片保护**: 芯片写保护
4. **电源问题**: 电源供应不足

#### 解决方案

##### 检查调试器连接
```
J-Link → STM32F103C8T6
├─ SWDIO → PA13
└─ SWCLK → PA14
```

##### 检查SWD接口
```
要求: 使用SWD接口，不要使用JTAG
配置: Debug: Serial Wire
代码: 不要使用 __HAL_AFIO_REMAP_SWJ_DISABLE()
```

##### 检查芯片保护
```
解决方法:
1. 使用ST-Link Utility解锁
2. 检查BOOT0引脚
3. 重新上电
```

##### 检查电源
```
要求:
- STM32: 3.3V
- 调试器: 5V
- 电流: >100mA
```

#### 调试步骤
1. 检查调试器连接
2. 检查SWD接口
3. 检查芯片保护
4. 检查电源供应
5. 使用ST-Link Utility

---

### 6️⃣ 程序不运行

#### 症状
- 程序烧录成功但不运行
- 数码管黑屏
- 按键无响应

#### 可能原因
1. **时钟配置错误**: 系统时钟配置错误
2. **中断配置错误**: 中断配置错误
3. **硬件初始化失败**: 硬件初始化失败
4. **死循环**: 程序进入死循环

#### 解决方案

##### 检查时钟配置
```c
// 检查系统时钟配置
void SystemClock_Config(void) {
    // 确保时钟配置正确
}
```

##### 检查中断配置
```c
// 检查中断配置
void MX_TIM4_Init(void) {
    // 确保定时器中断配置正确
}
```

##### 检查硬件初始化
```c
// 检查硬件初始化
int main(void) {
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_SPI2_Init();
    MX_TIM4_Init();
    // 确保所有硬件初始化成功
}
```

#### 调试步骤
1. 检查时钟配置
2. 检查中断配置
3. 检查硬件初始化
4. 使用调试器单步调试
5. 检查程序入口点

---

### 7️⃣ 显示异常

#### 症状
- 显示乱码
- 显示闪烁
- 显示不完整

#### 可能原因
1. **段码错误**: 段码表错误
2. **位选择错误**: 位选择错误
3. **刷新频率问题**: 显示刷新频率过低
4. **SPI时序问题**: SPI时序错误

#### 解决方案

##### 检查段码表
```c
// 检查段码表
const uint8_t seg_code[] = {
    0xC0, // 0: 0b11000000
    0xF9, // 1: 0b11111001
    0xA4, // 2: 0b10100100
    0xB0, // 3: 0b10110000
    0x99, // 4: 0b10011001
    0x92, // 5: 0b10010010
    0x82, // 6: 0b10000010
    0xF8, // 7: 0b11111000
    0x80, // 8: 0b10000000
    0x90  // 9: 0b10010000
};
```

##### 检查位选择
```c
// 检查位选择
#define D7_DIG1               0x01    // D7第1位
#define D7_DIG2               0x02    // D7第2位
#define D7_DIG3               0x04    // D7第3位
#define D7_DIG4               0x08    // D7第4位
#define D7_DIG5               0x10    // D7第5位
```

##### 检查刷新频率
```c
// 检查刷新频率
#define DISPLAY_REFRESH_RATE  100     // 显示刷新频率 (Hz)
```

#### 调试步骤
1. 检查段码表
2. 检查位选择
3. 检查刷新频率
4. 检查SPI时序
5. 使用示波器检查信号

---

### 8️⃣ 频率调节异常

#### 症状
- 频率调节不响应
- 步进值错误
- 长按不工作

#### 可能原因
1. **按键扫描问题**: 按键扫描异常
2. **步进算法错误**: 智能步进算法错误
3. **长按检测错误**: 长按检测算法错误
4. **频率范围错误**: 频率范围设置错误

#### 解决方案

##### 检查按键扫描
```c
// 检查按键扫描
uint8_t KEY_Scan(void) {
    uint16_t key_state = KEY_Read();
    // 确保按键扫描正常
}
```

##### 检查步进算法
```c
// 检查智能步进算法
static uint16_t GetFreqStep(uint16_t freq, uint16_t current_step) {
    // 确保步进算法正确
}
```

##### 检查长按检测
```c
// 检查长按检测
#define LONG_PRESS_TIME       500     // 长按检测时间 (ms)
#define FAST_PRESS_INTERVAL   200     // 快速按键间隔 (ms)
```

#### 调试步骤
1. 检查按键扫描
2. 检查步进算法
3. 检查长按检测
4. 检查频率范围
5. 使用调试器跟踪

---

## 🔧 调试工具

### 1️⃣ 硬件调试工具
- **万用表**: 检查电压和连接
- **示波器**: 检查信号波形
- **逻辑分析仪**: 检查数字信号
- **电源**: 稳定的电源供应

### 2️⃣ 软件调试工具
- **Keil调试器**: 程序调试
- **ST-Link Utility**: 芯片操作
- **串口调试**: 数据输出
- **LED指示**: 状态指示

### 3️⃣ 调试技巧
- **单步调试**: 逐步执行程序
- **断点调试**: 在关键点设置断点
- **变量监视**: 监视关键变量
- **内存检查**: 检查内存使用

---

## 📚 参考资源

### 1️⃣ 官方文档
- [STM32官方文档](https://www.st.com/en/microcontrollers-microprocessors/stm32-32-bit-arm-cortex-mcus.html)
- [Keil官方文档](https://www.keil.com/support/man/)
- [74HC595数据手册](https://www.ti.com/lit/ds/symlink/sn74hc595.pdf)
- [74HC165数据手册](https://www.ti.com/lit/ds/symlink/sn74hc165.pdf)

### 2️⃣ 项目文档
- [README.md](README.md) - 项目主说明
- [QUICKSTART.md](QUICKSTART.md) - 快速开始指南
- [HARDWARE_CONFIG.h](HARDWARE_CONFIG.h) - 硬件配置
- [配置指南](software/配置指南/) - 开发环境配置

### 3️⃣ 故障经验
- [故障经验](故障经验/) - 开发故障记录
- [硬件约束](.cursor/rules/current/hardware_constraints.md) - 硬件约束说明
- [AI规则](.cursor/rules/) - AI辅助开发

---

## 🆘 紧急求助

### 1️⃣ 快速检查清单
- [ ] 电源连接正常
- [ ] 调试器连接正常
- [ ] SPI连接正常
- [ ] 74HC595级联正常
- [ ] 74HC165连接正常
- [ ] 数码管连接正常
- [ ] LED连接正常
- [ ] 按键连接正常

### 2️⃣ 紧急恢复步骤
1. **重新上电**: 断开电源，等待10秒，重新上电
2. **重新烧录**: 使用ST-Link Utility重新烧录
3. **检查连接**: 检查所有硬件连接
4. **恢复默认**: 恢复默认配置

### 3️⃣ 联系支持
- **文档支持**: 查看相关文档
- **社区支持**: [ST官方社区](https://community.st.com/)
- **技术论坛**: 相关技术论坛
- **AI助手**: 使用Cursor AI助手

---

<div align="center">

## 🎯 故障排除成功！

**遇到问题不要慌，按照指南逐步排查！** 🔧

</div>
